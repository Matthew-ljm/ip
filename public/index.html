<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP信息发送服务</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .input-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input[type="email"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            min-height: 24px;
        }
        .success { background-color: #dff0d8; color: #3c763d; }
        .error { background-color: #f2dede; color: #a94442; }
        .info { background-color: #d9edf7; color: #31708f; }
        .info-note {
            margin-top: 30px;
            font-size: 0.9em;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>IP信息发送服务</h1>
    <p>当前环境: <span id="env"></span></p>
    
    <div class="input-group" id="emailInputGroup">
        <label for="recipientEmail">接收邮箱地址:</label>
        <input type="email" id="recipientEmail" placeholder="请输入接收邮件的邮箱地址" required>
    </div>
    
    <button id="sendBtn">发送IP信息到邮箱</button>
    <div id="status"></div>
    
    <script>
        // 定义来源页面URL
        const SOURCE_PAGE_URL = "https://ip.m-code.top/";
        
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const key = urlParams.get('key');
            
            // 尝试从环境变量获取API基础路径并显示（如果存在）
            const apiBaseElement = document.getElementById('api-base');
            if (window.API_BASE_URL) {
                apiBaseElement.textContent = window.API_BASE_URL;
            } else {
                apiBaseElement.textContent = '未配置';
            }
            
            // 尝试从环境变量获取当前环境并显示（如果存在）
            const envElement = document.getElementById('env');
            if (window.ENVIRONMENT) {
                envElement.textContent = window.ENVIRONMENT;
            } else {
                envElement.textContent = '未知';
            }
            
            // 处理key参数作为邮箱地址的情况
            if (key) {
                // 隐藏邮箱输入框，因为我们将使用key参数作为邮箱
                document.getElementById('emailInputGroup').style.display = 'none';
                
                // 验证key是否为有效的邮箱格式
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (emailRegex.test(key)) {
                    document.getElementById('status').textContent = `检测到邮箱地址参数，正在自动发送到 ${key}...`;
                    document.getElementById('status').className = 'info';
                    
                    // 延迟发送，让用户有时间看到提示
                    setTimeout(() => {
                        sendToEmail(key);
                    }, 1000);
                } else {
                    // 如果key不是有效的邮箱格式，显示错误信息并重新显示输入框
                    document.getElementById('emailInputGroup').style.display = 'block';
                    document.getElementById('status').textContent = '错误: key参数不是有效的邮箱地址，请输入邮箱地址';
                    document.getElementById('status').className = 'error';
                }
            } else {
                document.getElementById('status').textContent = '请输入邮箱地址并点击按钮发送IP信息';
            }
        });
        
        document.getElementById('sendBtn').addEventListener('click', async () => {
            const emailInput = document.getElementById('recipientEmail');
            const recipientEmail = emailInput.value.trim();
            
            // 验证邮箱输入
            if (!recipientEmail) {
                updateStatus('错误: 请输入接收邮箱地址', 'error');
                emailInput.focus();
                return;
            }
            
            // 简单的邮箱格式验证
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(recipientEmail)) {
                updateStatus('错误: 请输入有效的邮箱地址', 'error');
                emailInput.focus();
                return;
            }
            
            sendToEmail(recipientEmail);
        });
        
        // 发送IP信息到指定邮箱的函数
        async function sendToEmail(recipientEmail) {
            updateStatus('正在获取IP信息...', '');
            
            try {
                // 获取IP信息
                const ipApiUrl = `${window.location.origin}/api/proxy-ip`;
                console.log('请求IP信息:', ipApiUrl);
                
                const ipResponse = await fetch(ipApiUrl);
                const ipResponseText = await ipResponse.text();
                
                if (!ipResponse.ok) {
                    throw new Error(`获取IP信息失败 [${ipResponse.status}]: ${ipResponseText}`);
                }
                
                let ipData;
                try {
                    ipData = JSON.parse(ipResponseText);
                } catch (e) {
                    throw new Error(`IP信息解析失败: ${e.message}, 原始内容: ${ipResponseText}`);
                }
                
                updateStatus('正在发送邮件...', '');
                
                // 发送邮件
                const sendApiUrl = `${window.location.origin}/api/send-ip`;
                console.log('发送邮件请求:', sendApiUrl);
                
                const sendResponse = await fetch(sendApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ipData: ipData,
                        email: recipientEmail,
                        sourcePage: SOURCE_PAGE_URL,
                        autoGeneratedMessage: true
                    }),
                });
                
                const sendResponseText = await sendResponse.text();
                let result;
                try {
                    result = JSON.parse(sendResponseText);
                } catch (e) {
                    throw new Error(`邮件响应解析失败: ${e.message}, 原始内容: ${sendResponseText}`);
                }
                
                if (sendResponse.ok) {
                    updateStatus(`邮件已成功发送至 ${recipientEmail}！`, 'success');
                    // 如果是手动输入的情况，清空输入框
                    const emailInput = document.getElementById('recipientEmail');
                    if (emailInput) emailInput.value = '';
                } else {
                    throw new Error(result.error || '邮件发送失败');
                }
            } catch (error) {
                updateStatus(`错误: ${error.message}`, 'error');
                console.error('操作失败:', error);
            }
        }
        
        // 更新状态显示的辅助函数
        function updateStatus(message, className) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = className;
        }
    </script>
</body>
</html>